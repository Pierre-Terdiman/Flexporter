///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*
 *	OPCODE - Optimized Collision Detection
 *	Copyright (C) 2001 Pierre Terdiman
 *	Homepage: http://www.codercorner.com/Opcode.htm
 */
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/**
 *	Contains an implementation of the sweep-and-prune algorithm (moved from Z-Collide)
 *	\file		OPC_SweepAndPrune.h
 *	\author		Pierre Terdiman
 *	\date		January, 29, 2000
 */
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Include Guard
#ifndef OPC_SWEEPANDPRUNE_H
#define OPC_SWEEPANDPRUNE_H

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/**
	 *	User-callback, called by OPCODE for each colliding pairs.
	 *	\param		id0			[in] id of colliding object
	 *	\param		id1			[in] id of colliding object
	 *	\param		user_data	[in] user-defined data
	 *	\return		TRUE to continue enumeration
	 */
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	typedef BOOL	(*PairCallback)	(udword id0, udword id1, void* user_data);

	// Forward declarations
	class SAP_EndPoint;
	class SAP_Box;

#ifndef OPC_USE_PAIR_MANAGER
	class SAP_Element;

	class OPCODE_API SAP_PairData
	{
		public:
		//! Constructor
								SAP_PairData();
		//! Destructor
								~SAP_PairData();

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/**
		 *	Initializes the structure for a given number of object.
		 *	\param		nb_objects	[in] expected number of objects
		 *	\return		true if success
		 */
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
				bool			Init(udword nb_objects);

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/**
		 *	Adds a pair to the structure.
		 *	\param		id0	[in] id of first pair
		 *	\param		id1	[in] id of second pair
		 */
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
				void			AddPair(udword id0, udword id1);

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/**
		 *	Removes a pair from the structure.
		 *	\param		id0	[in] id of first pair
		 *	\param		id1	[in] id of second pair
		 */
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
				void			RemovePair(udword id0, udword id1);

				void			DumpPairs(Pairs& pairs)								const;
				void			DumpPairs(PairCallback callback, void* user_data)	const;
		private:
				udword			mNbElements;		//!< Total number of elements in the pool
				udword			mNbUsedElements;	//!< Number of used elements
				SAP_Element*	mElementPool;		//!< Array of mNbElements elements
				SAP_Element*	mFirstFree;			//!< First free element in the pool

				udword			mNbObjects;			//!< Max number of objects we can handle
				SAP_Element**	mArray;				//!< Pointers to pool
		// Internal methods
				SAP_Element*	GetFreeElem(udword id, SAP_Element* next, udword* remap=null);
		inline_	void			FreeElem(SAP_Element* elem);
				void			Release();
	};
#endif

	class OPCODE_API SweepAndPrune
	{
		public:
		//! Constructor
								SweepAndPrune();
		//! Destructor
								~SweepAndPrune();

				bool			Init(udword nb_objects, const AABB** boxes);
				bool			UpdateObject(udword i, const AABB& box);

				void			GetPairs(Pairs& pairs)								const;
				void			GetPairs(PairCallback callback, void* user_data)	const;

				udword			Raycast(const Ray& world_ray, Container& boxes, Container* visited=null);
		private:
#ifndef OPC_USE_PAIR_MANAGER
				SAP_PairData	mPairs;
#else
				PairManager		mPairs;
#endif
				udword			mNbObjects;		//!< Number of objects in the pools
				SAP_Box*		mBoxes;			//!< Pool of mNbObjects boxes
				SAP_EndPoint*	mList[3];		//!< Pools of mNbObjects*2 endpoints
		// Internal methods
				bool			CheckListsIntegrity();
	};

#endif // OPC_SWEEPANDPRUNE_H